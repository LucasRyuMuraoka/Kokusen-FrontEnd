<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kokusen Explorer — Frontend</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#86efac; --accent-2:#60a5fa;
    --glass: rgba(255,255,255,0.03);
    color-scheme: dark;
  }
  *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071022 0%, #081226 60%); color:#e6eef6;}
  header{display:flex;align-items:center;gap:16px;padding:18px 24px;border-bottom:1px solid rgba(255,255,255,0.03)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#04293b}
  h1{font-size:18px;margin:0}
  .subtitle{font-size:12px;color:var(--muted)}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  input,select,button,textarea{background:var(--card);border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:inherit}
  input[type=text]{min-width:300px}
  main{display:flex;gap:20px;padding:20px}
  nav{width:220px;background:rgba(255,255,255,0.02);padding:16px;border-radius:12px;min-height:60vh}
  nav h3{margin:6px 0 12px 0;color:var(--muted);font-size:13px}
  .nav-btn{display:block;padding:10px;border-radius:8px;margin-bottom:8px;text-decoration:none;color:inherit}
  .nav-btn.active{background:linear-gradient(90deg, rgba(134,239,172,0.08), rgba(96,165,250,0.06));box-shadow:0 4px 18px rgba(6,8,15,0.6)}
  section.viewer{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;min-height:60vh;overflow:auto}
  .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  .card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:12px}
  .card{background:var(--glass);border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03)}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:13px}
  .btn{padding:8px 10px;border-radius:8px;border:none;background:var(--accent-2);color:#06203a;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .form-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  textarea{min-height:80px}
  .detail{display:flex;gap:12px;align-items:flex-start}
  .detail .meta{flex:1}
  footer{padding:18px 24px;color:var(--muted);font-size:13px;border-top:1px solid rgba(255,255,255,0.02);text-align:center}
  .search{display:flex;gap:8px;align-items:center}
  .chip{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}
  .link{color:var(--accent-2);cursor:pointer;text-decoration:underline}
  .flex{display:flex;align-items:center;gap:8px}
  pre{white-space:pre-wrap;background:#041226;padding:10px;border-radius:8px;color:var(--muted);font-size:13px}
  @media(max-width:900px){nav{display:none} main{padding:12px}}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">K</div>
    <div>
      <h1>Kokusen Explorer</h1>
      <div class="subtitle">Frontend bonito para consumir sua API — Quarkus (single file)</div>
    </div>
  </div>
  <div class="controls">
    <label class="muted" for="baseUrl">API Base URL</label>
    <input id="baseUrl" type="text" value="https://kokusen-lucasryu.onrender.com" />
  </div>
</header>

<main>
  <nav>
    <h3>Recursos</h3>
    <a class="nav-btn active" data-tab="characters">Characters</a>
    <a class="nav-btn" data-tab="clans">Clans</a>
    <a class="nav-btn" data-tab="techniques">Techniques</a>
    <a class="nav-btn" data-tab="domain-expansions">Domain Expansions</a>
    <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0" />
    <div class="muted">Dicas</div>
    <div style="margin-top:8px" class="small">Coloque a URL base (ex: <span class="chip">https://kokusen-lucasryu.onrender.com</span>). Use o painel para criar, editar, buscar e deletar recursos.</div>
  </nav>

  <section class="viewer">
    <div id="app">
      <!-- Toolbar -->
      <div class="toolbar">
        <div class="search">
          <input id="q" type="text" placeholder="Pesquisar por nome..." />
          <button id="btnSearch" class="btn">Pesquisar</button>
        </div>
        <div style="margin-left:auto" class="flex">
          <select id="pageSize">
            <option value="5">5 por página</option>
            <option value="10" selected>10 por página</option>
            <option value="20">20 por página</option>
          </select>
          <button id="btnCreate" class="btn">Criar novo</button>
          <button id="btnRefresh" class="btn ghost">Atualizar</button>
        </div>
      </div>

      <!-- Main content placeholder -->
      <div id="content">
        <!-- dynamic -->
      </div>

      <!-- raw response -->
      <div style="margin-top:14px">
        <div class="muted">Última resposta (raw):</div>
        <pre id="raw">Nenhuma requisição ainda.</pre>
      </div>
    </div>
  </section>
</main>

<footer>Feito para a API <strong>Kokusen</strong>. Arquivo único: HTML + CSS + JS.</footer>

<script>
/*
  Kokusen Explorer — a single-file frontend.
  It supports: characters, clans, techniques, domain-expansions.
  Uses the API paths described in the OpenAPI you provided.
  NOTE: ping/health functionality removed per request (não foi incluído nada fora da doc).
*/

const state = {
  base: document.getElementById('baseUrl').value.replace(/\/+$/, ''),
  tab: 'characters',
  page: 1,
  size: 10,
  q: '',
  lastResponse: null
};

const elements = {
  content: document.getElementById('content'),
  raw: document.getElementById('raw'),
  baseUrl: document.getElementById('baseUrl'),
  q: document.getElementById('q'),
  btnSearch: document.getElementById('btnSearch'),
  btnCreate: document.getElementById('btnCreate'),
  btnRefresh: document.getElementById('btnRefresh'),
  pageSize: document.getElementById('pageSize'),
  navBtns: document.querySelectorAll('.nav-btn'),
};

function setRaw(r){ elements.raw.textContent = r ? (typeof r === 'string' ? r : JSON.stringify(r, null, 2)) : '---'; }
function updateBase(){ state.base = elements.baseUrl.value.replace(/\/+$/, ''); }

elements.baseUrl.addEventListener('change', updateBase);

elements.navBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    elements.navBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    state.tab = btn.dataset.tab;
    state.page = 1;
    render();
  });
});

elements.btnSearch.addEventListener('click', ()=>{ state.q = elements.q.value.trim(); state.page = 1; render(); });
elements.btnRefresh.addEventListener('click', ()=> render());
elements.pageSize.addEventListener('change', ()=> { state.size = +elements.pageSize.value; render(); });
elements.btnCreate.addEventListener('click', ()=> openCreateForm());

function showError(e){
  let msg = 'Erro';
  if(e instanceof Response){
    e.text().then(t=> setRaw(t));
    msg = 'Requisição falhou: ' + e.status;
  } else {
    msg = e.message || String(e);
    setRaw(msg);
  }
  alert(msg);
}

async function apiFetch(path, opts={}){
  updateBase();
  const url = (path.startsWith('http') ? path : state.base + path);
  const headers = opts.headers || {};
  if(!(opts.body instanceof FormData)) headers['Content-Type'] = 'application/json';
  const final = Object.assign({method:'GET', headers}, opts);
  if(final.body && typeof final.body !== 'string' && !(final.body instanceof FormData)){
    final.body = JSON.stringify(final.body);
  }
  const res = await fetch(url, final);
  const text = await res.text();
  let parsed = null;
  try{ parsed = text ? JSON.parse(text) : null; } catch(e){}
  state.lastResponse = {status: res.status, ok: res.ok, body: parsed ?? text};
  setRaw(state.lastResponse);
  if(!res.ok) {
    const ex = res;
    throw ex;
  }
  return parsed;
}

/* ---------- Renderers for each resource ---------- */

async function render(){
  elements.q.value = state.q;
  if(state.tab === 'characters') await renderCharacters();
  if(state.tab === 'clans') await renderClans();
  if(state.tab === 'techniques') await renderTechniques();
  if(state.tab === 'domain-expansions') await renderDomainExpansions();
}

function makeCard(htmlInner){ const d = document.createElement('div'); d.className='card'; d.innerHTML = htmlInner; return d; }

/* --------- Characters --------- */
async function renderCharacters(){
  elements.content.innerHTML = '<h2>Characters</h2>';
  const toolbar = document.createElement('div'); toolbar.className='toolbar';
  elements.content.appendChild(toolbar);

  try{
    let path = '/characters';
    const params = new URLSearchParams();
    params.set('page', state.page);
    params.set('size', state.size);
    if(state.q) { path = '/characters/search'; params.set('q', state.q); }
    const url = path + '?' + params.toString();
    const data = await apiFetch(url);
    const list = Array.isArray(data) ? data : (data.content || data.characters || data);
    const grid = document.createElement('div'); grid.className='card-grid';
    if(Array.isArray(list) && list.length){
      list.forEach(ch => {
        const html = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700">${escapeHtml(ch.name||'—')}</div>
              <div class="muted small">${escapeHtml(ch.rank||'—')} • ${escapeHtml(ch.clanName||'Sem clã')}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px">
              <button class="btn" onclick="viewCharacter(${ch.id})">Ver</button>
              <button class="btn ghost" onclick="editCharacter(${ch.id})">Editar</button>
            </div>
          </div>
        `;
        grid.appendChild(makeCard(html));
      });
    } else {
      grid.appendChild(makeCard('<div class="muted">Nenhum personagem encontrado.</div>'));
    }
    elements.content.appendChild(grid);

  } catch(e){
    showError(e);
  }
}

/* Character helpers */
window.viewCharacter = async function(id){
  try{
    const ch = await apiFetch('/characters/' + id);
    const detail = document.createElement('div');
    detail.innerHTML = `<h3>${escapeHtml(ch.name)}</h3><div class="muted">Rank: ${escapeHtml(ch.rank||'—')}</div><div class="muted">Clan: ${escapeHtml(ch.clanName||'—')}</div>
      <div style="margin-top:8px"><strong>Técnicas:</strong></div>
      <div style="margin-top:6px">${(ch.links && ch.links.length)? ch.links.map(l=> \`<div class="chip">${escapeHtml(l.rel)}: <span class="link" onclick="window.open('\${l.href}','_blank')">\${escapeHtml(l.href)}</span></div>\`).join(' ') : '<span class=\"muted\">Nenhuma</span>'}</div>
      <div style="margin-top:12px">
        <button class="btn" onclick="editCharacter(${ch.id})">Editar</button>
        <button class="btn ghost" onclick="deleteCharacter(${ch.id})">Deletar</button>
      </div>
      <hr/>
      <pre>${escapeHtml(JSON.stringify(ch, null, 2))}</pre>
    `;
    showModal('Character', detail.innerHTML);
  }catch(e){ showError(e); }
}

window.editCharacter = async function(id){
  try{
    const ch = await apiFetch('/characters/' + id);
    const form = document.createElement('div');
    form.innerHTML = `
      <div class="form-row"><label>Nome</label><input id="ch_name" value="${escapeAttr(ch.name||'')}" /></div>
      <div class="form-row"><label>Rank</label><input id="ch_rank" value="${escapeAttr(ch.rank||'')}" /></div>
      <div class="form-row"><label>Clan Name</label><input id="ch_clanName" value="${escapeAttr(ch.clanName||'')}" /></div>
      <div class="form-row"><label>Technique Names (vírgula)</label><input id="ch_techs" value="${escapeAttr((ch.techniqueNames||[]).join(', '))}" /></div>
      <div class="form-row"><label>Domain Expansion Name</label><input id="ch_domain" value="${escapeAttr(ch.domainExpansionName||'')}" /></div>
      <div style="margin-top:8px"><button id="saveCh" class="btn">Salvar</button> <button id="cancelCh" class="btn ghost">Cancelar</button></div>
    `;
    showModal('Editar personagem', form.innerHTML);
    document.getElementById('saveCh').addEventListener('click', async ()=>{
      const body = {
        name: document.getElementById('ch_name').value,
        rank: document.getElementById('ch_rank').value,
        clanName: document.getElementById('ch_clanName').value,
        techniqueNames: document.getElementById('ch_techs').value.split(',').map(s=>s.trim()).filter(Boolean),
        domainExpansionName: document.getElementById('ch_domain').value
      };
      try{
        await apiFetch('/characters/' + id, {method:'PUT', body});
        alert('Atualizado com sucesso');
        render();
        closeModal();
      }catch(e){ showError(e); }
    });
    document.getElementById('cancelCh').addEventListener('click', closeModal);
  }catch(e){ showError(e); }
}

window.deleteCharacter = async function(id){
  if(!confirm('Deletar personagem #' + id + '?')) return;
  try{
    await apiFetch('/characters/' + id, {method:'DELETE'});
    alert('Deletado');
    render();
  }catch(e){ showError(e); }
}

/* Create form for character */
function openCreateForm(){
  if(state.tab === 'characters') openCreateCharacter();
  if(state.tab === 'clans') openCreateClan();
  if(state.tab === 'techniques') openCreateTechnique();
  if(state.tab === 'domain-expansions') openCreateDomainExpansion();
}

function openCreateCharacter(){
  const html = `
    <div class="form-row"><label>Nome</label><input id="ch_name" /></div>
    <div class="form-row"><label>Rank</label><input id="ch_rank" /></div>
    <div class="form-row"><label>Clan Name</label><input id="ch_clanName" /></div>
    <div class="form-row"><label>Technique Names (vírgula)</label><input id="ch_techs" /></div>
    <div class="form-row"><label>Domain Expansion Name</label><input id="ch_domain" /></div>
    <div style="margin-top:8px"><button id="saveCh" class="btn">Criar</button> <button id="cancelCh" class="btn ghost">Cancelar</button></div>
  `;
  showModal('Criar personagem', html);
  document.getElementById('saveCh').addEventListener('click', async ()=>{
    const body = {
      name: document.getElementById('ch_name').value,
      rank: document.getElementById('ch_rank').value,
      clanName: document.getElementById('ch_clanName').value,
      techniqueNames: document.getElementById('ch_techs').value.split(',').map(s=>s.trim()).filter(Boolean),
      domainExpansionName: document.getElementById('ch_domain').value
    };
    try{
      await apiFetch('/characters', {method:'POST', body});
      alert('Criado');
      render();
      closeModal();
    }catch(e){ showError(e); }
  });
  document.getElementById('cancelCh').addEventListener('click', closeModal);
}

/* --------- Clans --------- */
async function renderClans(){
  elements.content.innerHTML = '<h2>Clans</h2>';
  try{
    let path = '/clans';
    const params = new URLSearchParams();
    params.set('page', state.page);
    params.set('size', state.size);
    if(state.q){ path = '/clans/search'; params.set('q', state.q); }
    const data = await apiFetch(path + '?' + params.toString());
    const list = Array.isArray(data) ? data : (data.content || data.clans || data);
    const grid = document.createElement('div'); grid.className='card-grid';
    if(Array.isArray(list) && list.length){
      list.forEach(cl => {
        const html = `
          <div>
            <div style="display:flex;justify-content:space-between">
              <div>
                <div style="font-weight:700">${escapeHtml(cl.name||'—')}</div>
                <div class="muted small">${escapeHtml(cl.description||'')}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <button class="btn" onclick="viewClan(${cl.id})">Ver</button>
                <button class="btn ghost" onclick="editClan(${cl.id})">Editar</button>
              </div>
            </div>
          </div>
        `;
        grid.appendChild(makeCard(html));
      });
    } else {
      grid.appendChild(makeCard('<div class="muted">Nenhum clã encontrado.</div>'));
    }
    elements.content.appendChild(grid);
  }catch(e){ showError(e); }
}

window.viewClan = async function(id){
  try{
    const cl = await apiFetch('/clans/' + id);
    const html = `<h3>${escapeHtml(cl.name)}</h3><div class="muted">${escapeHtml(cl.description||'')}</div>
      <div style="margin-top:12px"><button class="btn" onclick="editClan(${cl.id})">Editar</button> <button class="btn ghost" onclick="deleteClan(${cl.id})">Deletar</button></div>
      <hr/><pre>${escapeHtml(JSON.stringify(cl, null, 2))}</pre>`;
    showModal('Clan', html);
  }catch(e){ showError(e); }
}

window.editClan = async function(id){
  try{
    const cl = await apiFetch('/clans/' + id);
    const form = document.createElement('div');
    form.innerHTML = `
      <div class="form-row"><label>Nome</label><input id="cl_name" value="${escapeAttr(cl.name||'')}" /></div>
      <div class="form-row"><label>Descrição</label><textarea id="cl_desc">${escapeAttr(cl.description||'')}</textarea></div>
      <div style="margin-top:8px"><button id="saveCl" class="btn">Salvar</button> <button id="cancelCl" class="btn ghost">Cancelar</button></div>
    `;
    showModal('Editar clã', form.innerHTML);
    document.getElementById('saveCl').addEventListener('click', async ()=>{
      const body = { name: document.getElementById('cl_name').value, description: document.getElementById('cl_desc').value };
      try{ await apiFetch('/clans/' + id, {method:'PUT', body}); alert('Atualizado'); render(); closeModal(); }catch(e){ showError(e); }
    });
    document.getElementById('cancelCl').addEventListener('click', closeModal);
  }catch(e){ showError(e); }
}

window.deleteClan = async function(id){
  if(!confirm('Deletar clã #' + id + '?')) return;
  try{ await apiFetch('/clans/' + id, {method:'DELETE'}); alert('Deletado'); render(); }catch(e){ showError(e); }
}

function openCreateClan(){
  const html = `
    <div class="form-row"><label>Nome</label><input id="cl_name" /></div>
    <div class="form-row"><label>Descrição</label><textarea id="cl_desc"></textarea></div>
    <div style="margin-top:8px"><button id="saveCl" class="btn">Criar</button> <button id="cancelCl" class="btn ghost">Cancelar</button></div>
  `;
  showModal('Criar clã', html);
  document.getElementById('saveCl').addEventListener('click', async ()=>{
    const body = { name: document.getElementById('cl_name').value, description: document.getElementById('cl_desc').value };
    try{ await apiFetch('/clans', {method:'POST', body}); alert('Criado'); render(); closeModal(); }catch(e){ showError(e); }
  });
  document.getElementById('cancelCl').addEventListener('click', closeModal);
}

/* --------- Techniques --------- */
async function renderTechniques(){
  elements.content.innerHTML = '<h2>Techniques</h2>';
  try{
    let path = '/techniques';
    const params = new URLSearchParams();
    params.set('page', state.page);
    params.set('size', state.size);
    if(state.q){ path = '/techniques/search'; params.set('q', state.q); }
    const data = await apiFetch(path + '?' + params.toString());
    const list = Array.isArray(data) ? data : (data.content || data.techniques || data);
    const grid = document.createElement('div'); grid.className='card-grid';
    if(Array.isArray(list) && list.length){
      list.forEach(t => {
        const html = `
          <div>
            <div style="display:flex;justify-content:space-between">
              <div>
                <div style="font-weight:700">${escapeHtml(t.name||'—')}</div>
                <div class="muted small">${escapeHtml((t.description||'').slice(0,120))}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <button class="btn" onclick="viewTechnique(${t.id})">Ver</button>
                <button class="btn ghost" onclick="editTechnique(${t.id})">Editar</button>
              </div>
            </div>
          </div>
        `;
        grid.appendChild(makeCard(html));
      });
    } else {
      grid.appendChild(makeCard('<div class="muted">Nenhuma técnica encontrada.</div>'));
    }
    elements.content.appendChild(grid);
  }catch(e){ showError(e); }
}

window.viewTechnique = async function(id){
  try{
    const t = await apiFetch('/techniques/' + id);
    const html = `<h3>${escapeHtml(t.name)}</h3><div class="muted">${escapeHtml(t.description||'')}</div>
      <div style="margin-top:12px"><button class="btn" onclick="editTechnique(${t.id})">Editar</button> <button class="btn ghost" onclick="deleteTechnique(${t.id})">Deletar</button></div>
      <hr/><pre>${escapeHtml(JSON.stringify(t, null, 2))}</pre>`;
    showModal('Technique', html);
  }catch(e){ showError(e); }
}

window.editTechnique = async function(id){
  try{
    const t = await apiFetch('/techniques/' + id);
    const form = document.createElement('div');
    form.innerHTML = `
      <div class="form-row"><label>Nome</label><input id="t_name" value="${escapeAttr(t.name||'')}" /></div>
      <div class="form-row"><label>Descrição</label><textarea id="t_desc">${escapeAttr(t.description||'')}</textarea></div>
      <div style="margin-top:8px"><button id="saveT" class="btn">Salvar</button> <button id="cancelT" class="btn ghost">Cancelar</button></div>
    `;
    showModal('Editar técnica', form.innerHTML);
    document.getElementById('saveT').addEventListener('click', async ()=>{
      const body = { name: document.getElementById('t_name').value, description: document.getElementById('t_desc').value };
      try{ await apiFetch('/techniques/' + id, {method:'PUT', body}); alert('Atualizado'); render(); closeModal(); }catch(e){ showError(e); }
    });
    document.getElementById('cancelT').addEventListener('click', closeModal);
  }catch(e){ showError(e); }
}

window.deleteTechnique = async function(id){
  if(!confirm('Deletar técnica #' + id + '?')) return;
  try{ await apiFetch('/techniques/' + id, {method:'DELETE'}); alert('Deletado'); render(); }catch(e){ showError(e); }
}

function openCreateTechnique(){
  const html = `
    <div class="form-row"><label>Nome</label><input id="t_name" /></div>
    <div class="form-row"><label>Descrição</label><textarea id="t_desc"></textarea></div>
    <div style="margin-top:8px"><button id="saveT" class="btn">Criar</button> <button id="cancelT" class="btn ghost">Cancelar</button></div>
  `;
  showModal('Criar técnica', html);
  document.getElementById('saveT').addEventListener('click', async ()=>{
    const body = { name: document.getElementById('t_name').value, description: document.getElementById('t_desc').value };
    try{ await apiFetch('/techniques', {method:'POST', body}); alert('Criado'); render(); closeModal(); }catch(e){ showError(e); }
  });
  document.getElementById('cancelT').addEventListener('click', closeModal);
}

/* --------- Domain Expansions --------- */
async function renderDomainExpansions(){
  elements.content.innerHTML = '<h2>Domain Expansions</h2>';
  try{
    let path = '/domain-expansions';
    const params = new URLSearchParams();
    params.set('page', state.page);
    params.set('size', state.size);
    if(state.q){ path = '/domain-expansions/search'; params.set('q', state.q); }
    const data = await apiFetch(path + '?' + params.toString());
    const list = Array.isArray(data) ? data : (data.content || data.domainExpansions || data);
    const grid = document.createElement('div'); grid.className='card-grid';
    if(Array.isArray(list) && list.length){
      list.forEach(d => {
        const html = `
          <div>
            <div style="display:flex;justify-content:space-between">
              <div>
                <div style="font-weight:700">${escapeHtml(d.name||'—')}</div>
                <div class="muted small">${escapeHtml((d.effect||'').slice(0,120))}</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px">
                <button class="btn" onclick="viewDomain(${d.id})">Ver</button>
                <button class="btn ghost" onclick="editDomain(${d.id})">Editar</button>
              </div>
            </div>
          </div>
        `;
        grid.appendChild(makeCard(html));
      });
    } else {
      grid.appendChild(makeCard('<div class="muted">Nenhuma expansão encontrada.</div>'));
    }
    elements.content.appendChild(grid);
  }catch(e){ showError(e); }
}

window.viewDomain = async function(id){
  try{
    const d = await apiFetch('/domain-expansions/' + id);
    const html = `<h3>${escapeHtml(d.name)}</h3><div class="muted">${escapeHtml(d.effect||'')}</div>
      <div style="margin-top:12px"><button class="btn" onclick="editDomain(${d.id})">Editar</button> <button class="btn ghost" onclick="deleteDomain(${d.id})">Deletar</button></div>
      <hr/><pre>${escapeHtml(JSON.stringify(d, null, 2))}</pre>`;
    showModal('Domain Expansion', html);
  }catch(e){ showError(e); }
}

window.editDomain = async function(id){
  try{
    const d = await apiFetch('/domain-expansions/' + id);
    const form = document.createElement('div');
    form.innerHTML = `
      <div class="form-row"><label>Nome</label><input id="d_name" value="${escapeAttr(d.name||'')}" /></div>
      <div class="form-row"><label>Efeito</label><textarea id="d_eff">${escapeAttr(d.effect||'')}</textarea></div>
      <div style="margin-top:8px"><button id="saveD" class="btn">Salvar</button> <button id="cancelD" class="btn ghost">Cancelar</button></div>
    `;
    showModal('Editar Domain Expansion', form.innerHTML);
    document.getElementById('saveD').addEventListener('click', async ()=>{
      const body = { name: document.getElementById('d_name').value, effect: document.getElementById('d_eff').value };
      try{ await apiFetch('/domain-expansions/' + id, {method:'PUT', body}); alert('Atualizado'); render(); closeModal(); }catch(e){ showError(e); }
    });
    document.getElementById('cancelD').addEventListener('click', closeModal);
  }catch(e){ showError(e); }
}

window.deleteDomain = async function(id){
  if(!confirm('Deletar domain expansion #' + id + '?')) return;
  try{ await apiFetch('/domain-expansions/' + id, {method:'DELETE'}); alert('Deletado'); render(); }catch(e){ showError(e); }
}

function openCreateDomainExpansion(){
  const html = `
    <div class="form-row"><label>Nome</label><input id="d_name" /></div>
    <div class="form-row"><label>Efeito</label><textarea id="d_eff"></textarea></div>
    <div style="margin-top:8px"><button id="saveD" class="btn">Criar</button> <button id="cancelD" class="btn ghost">Cancelar</button></div>
  `;
  showModal('Criar Domain Expansion', html);
  document.getElementById('saveD').addEventListener('click', async ()=>{
    const body = { name: document.getElementById('d_name').value, effect: document.getElementById('d_eff').value };
    try{ await apiFetch('/domain-expansions', {method:'POST', body}); alert('Criado'); render(); closeModal(); }catch(e){ showError(e); }
  });
  document.getElementById('cancelD').addEventListener('click', closeModal);
}

/* ---------- utilities: modals, escape ---------- */

function showModal(title, html){
  const overlay = document.createElement('div');
  overlay.id = '__overlay';
  Object.assign(overlay.style, {position:'fixed',inset:0,background:'rgba(0,0,0,0.6)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:9999});
  const box = document.createElement('div');
  box.style.width = '820px';
  box.style.maxWidth = '95%';
  box.style.maxHeight = '90%';
  box.style.overflow = 'auto';
  box.style.borderRadius = '12px';
  box.style.padding = '18px';
  box.style.background = 'linear-gradient(180deg, rgba(10,14,20,0.98), rgba(8,10,14,0.96))';
  box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><div><strong>${title}</strong></div><div><button id="closeModalBtn" class="btn ghost">Fechar</button></div></div>` + html;
  overlay.appendChild(box);
  document.body.appendChild(overlay);
  document.getElementById('closeModalBtn').addEventListener('click', closeModal);
}
function closeModal(){ const o = document.getElementById('__overlay'); if(o) o.remove(); }

function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g, function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])}); }
function escapeAttr(s){ return (s===null||s===undefined)?'':String(s).replace(/"/g, '&quot;') }

/* Initialize */
render();

</script>
</body>
</html>
